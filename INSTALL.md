
# OptiTrust Installation

--------------------------------------------------------------------------------
## Installation

### Install OCaml and system packages

It takes about 30 minutes to install the required OCaml software.

Installation of system packages:

```sh
   # lib for OpenMP, for dev files, and coreutils for nohup
   sudo apt-get install libomp-dev pkg-config zlib1g-dev coreutils
   # for C++ headers support:
   sudo apt-get install libc++-dev
   # optional, only if you prefer using `meld` over `code -d` for viewing diffs:
   sudo apt-get install meld
```


Install Clang 15. IMPORTANT: versions released after 15.0.x are not supported by the Clangml package that OptiTrust depends upon. (Thus, don't use `sudo apt-get install clang libclang-dev llvm-dev`). You can try this procedure:

```sh
wget https://apt.llvm.org/llvm.sh  
chmod +x llvm.sh 
sudo ./llvm.sh 15
sudo apt install autoconf libclang-15-dev llvm-15-dev

```
you need to make a symbolic link to redirect clang to clang-15 : 
```sh
sudo ln -s /usr/bin/clang-15 /usr/local/bin/clang
```

Depending on your prior installation, you might need to add the newly installed version of clang/llvm-config to the path, then select it among all of your versions :

```
  sudo update-alternatives --install /usr/bin/clang clang /usr/bin/clang-15 100
  sudo update-alternatives --config clang
```

```
  sudo update-alternatives --install /usr/bin/llvm-config llvm-config /usr/bin/llvm-config-15 100
  sudo update-alternatives --config llvm-config
```

TODO: don't make this global switch, bad for benchmarking

Installation of Opam, the OCaml package manager (don't use `sudo apt-get install opam` as it might give you an out of date version).
The following one-liner is advertised on `https://opam.ocaml.org/doc/Install.html`.

```
  bash -c "sh <(curl -fsSL https://opam.ocaml.org/install.sh)"
```

Installation of the opam switch with relevant packages:

```sh
   opam init
   opam switch create 4.14.1+options --packages=ocaml-variants.4.14.1+options,ocaml-option-flambda
   opam pin add dune 3.18.0
   opam pin add menhirLib 20210419
   opam pin add pprint 20220103
   opam pin add clangml 4.8.0  # -> continueanyway 
   opam install dune refl clangml pprint menhir menhirLib base64 ocamlbuild ocaml-lsp-server ppx_deriving
   # next line used only for generating the documentation of OptiTrust:
   opam install odoc lambdasoup
   # fancy traces
   opam install dream
   # then in any case execute the last line below
   eval $(opam env)
```

 Note: dune 3.19.0 is known to have an issue, when executing the tester script use 3.18.0 instead

 Note: clangml 4.8.0 is from Sept 2022.

 Note: graphics is used by the pview tool only.

### Install precommit hooks

This command configures git to automatically run unit tests between commits. It can be ignored if you just want to try OptiTrust without contributing, and you have not downloaded the source files through git.

```sh
  make install_git_hooks
```

### Precompiling headers

For faster compilation, we precompile header files.

```sh
  make precompile
```

If you ever see an error about "PCH files", run `make clean` to remove compiled headers.

### Test your installation from the command line

Checking your installation of OptiTrust is working:

```sh
  ./tester run tile
```
If this works, try :

```sh
   make tests
```

### Configure VScode (or VSCodium) for interactive usage

DO NOT USE SNAP VERSION OF VSCODE.
Indeed, the snap version use a sandbox that makes it unreliable to perform
the opening of browser windows from within VSCode tasks.

You can install either VSCode or VSCodium (more open).
To install VSCode, visit: https://code.visualstudio.com/docs/?dv=linux64_deb

Download the `.deb` package, then open it using "Software Install".

Alternative installation procedure for Codium via apt-get:

```sh
   wget -qO - https://gitlab.com/paulcarroty/vscodium-deb-rpm-repo/raw/master/pub.gpg \
    | gpg --dearmor | sudo dd of=/usr/share/keyrings/vscodium-archive-keyring.gpg
   echo 'deb [ signed-by=/usr/share/keyrings/vscodium-archive-keyring.gpg ] https://download.vscodium.com/debs vscodium main' \
    | sudo tee /etc/apt/sources.list.d/vscodium.list
   sudo apt update
   sudo apt install codium
```

In the rest of this tutorial, we assume VSCode. If you are using VSCodium,
you probably have an existing alias from 'code' to 'codium'. If not, you
may want to add into your `~/.bashrc` the line:
```bash
   alias code='codium'
```
(or use `sudo ln -s /usr/bin/codium /usr/bin/code`).


--------------------------------------------------------------------------------
## Browser installation

Recommended: installation of Chromium browser, which is very fast for
opening up the "diff" pages generated by OptiTrust:

```sh
   sudo snap install chromium
```

Firefox can also be used, and can also be installed using snap, however you
may encountered issues with GTK libs conflicting or not being found.
To install Firefox via apt:

```
sudo install -d -m 0755 /etc/apt/keyrings  # might not be needed
wget -q https://packages.mozilla.org/apt/repo-signing-key.gpg -O- | sudo tee /etc/apt/keyrings/packages.mozilla.org.asc > /dev/null
gpg -n -q --import --import-options import-show /etc/apt/keyrings/packages.mozilla.org.asc | awk '/pub/{getline; gsub(/^ +| +$/,""); if($0 == "35BAA0B33E9EB396F59CA838C0BA5CE6DC6315A3") print "\nSuccess.\n"; else print "\nFailure.\n"}'
echo "deb [signed-by=/etc/apt/keyrings/packages.mozilla.org.asc] https://packages.mozilla.org/apt mozilla main" | sudo tee -a /etc/apt/sources.list.d/mozilla.list > /dev/null
# Give priority:
echo '
Package: *
Pin: origin packages.mozilla.org
Pin-Priority: 1000
' | sudo tee /etc/apt/preferences.d/mozilla
sudo apt update && sudo apt install firefox
```

--------------------------------------------------------------------------------
## Configuration of VSCode

The point is to set up keybindings for interactive development of tranformation
scripts. For example, F6 shows the diff associated with the transformation
covering the cursor position in the VSCode editor.

### Open VSCode

From the folder that contains present README file, open VSCode using:

```sh

   code . &
   # or
   codium . &

```

### Install the OCaml platform:

Open the extension pannel (`ctrl+shift+x`) and look for the "Ocaml platform" extension.
Alternatively, use the quick open prompt (`ctrl+p`), then paste `ext install ocamllabs.ocaml-platform`.

### Install the OptiTrust shortcuts for VSCode

In VSCode, open the file `~/.config/Code/User/keybindings.json`.
For VSCodium, this file is located at `~/.config/VSCodium/User/keybindings.json`.
If you have an empty file, paste the following contents.
If you have a nonempty file, copy the bindings into your file.

```jsonc
[
  // OptiTrust keybindings
  {
    "key": "f5",
    "command": "workbench.action.tasks.runTask",
    "args": "Redo last view command",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "shift+f5",
    "command": "workbench.action.tasks.runTask",
    "args": "View trace",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+f5",
    "command": "workbench.action.tasks.runTask",
    "args": "View trace -save-steps script",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+shift+f5",
    "command": "workbench.action.tasks.runTask",
    "args": "View standalone trace -save-steps script",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "alt+ctrl+shift+f5", // experimental, only for advanced users, heavier trace
    "command": "workbench.action.tasks.runTask",
    "args": "View standalone trace -save-steps important",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "shift+f6",
    "command": "workbench.action.tasks.runTask",
    "args": "View trace for one step",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "f6",
    "command": "workbench.action.tasks.runTask",
    "args": "View diff",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+f6",
    "command": "workbench.action.tasks.runTask",
    "args": "View diff only code",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+shift+f6",
    "command": "workbench.action.tasks.runTask",
    "args": "View diff using internal syntax",
    "when": "config.optitrust.enableKeybindings"
  },
  // For working with unit tests
  {
    "key": "f10",
    "command": "workbench.action.tasks.runTask",
    "args": "Rerun the last-tried test(s)",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+f10",
    "command": "workbench.action.tasks.runTask",
    "args": "Run the current test",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+shift+f10",
    "command": "workbench.action.tasks.runTask",
    "args": "Run and open diff for the current test",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "shift+f10",
    "command": "workbench.action.tasks.runTask",
    "args": "Run all the tests",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "alt+shift+f10",
    "command": "workbench.action.tasks.runTask",
    "args": "Open unit test ML and CPP files",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "alt+f10",
    "command": "workbench.action.tasks.runTask",
    "args": "Open unit test ML and CPP files and documentation",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "alt+ctrl+shift+f10",
    "command": "workbench.action.tasks.runTask",
    "args": "Compile with gcc", // LATER: might want to use clang instead
    "when": "config.optitrust.enableKeybindings"
  },  
  // For working with long transformation scripts (might not be maintained)
  {
    "key": "f7",
    "command": "workbench.action.tasks.runTask",
    "args": "View diff from intermediate state",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "shift+f7",
    "command": "workbench.action.tasks.runTask",
    "args": "View trace from intermediate state",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+f7",
    "command": "workbench.action.tasks.runTask",
    "args": "Save intermediate state",
    "when": "config.optitrust.enableKeybindings"
  },
  // For viewing documentation
  {
    "key": "f11",
    "command": "workbench.action.tasks.runTask",
    "args": "Open doc for current source file in browser",
    "when": "config.optitrust.enableKeybindings && (resourceExtname == .ml || resourceExtname == .cpp)"
  },
  {
    "key": "ctrl+f11",
    "command": "workbench.action.tasks.runTask",
    "args": "Execute make viewdoc",
    "when": "config.optitrust.enableKeybindings"
  },
  {
    "key": "ctrl+shift+f11",
    "command": "workbench.action.tasks.runTask",
    "args": "Execute make doc viewdoc",
    "when": "config.optitrust.enableKeybindings"
  },
  // For testing OptiTrust shortcuts
  {
    "key": "alt+shift+f11",
    "command": "workbench.action.tasks.runTask",
    "args": "Test OptiTrust Shortcuts",
    "when": "config.optitrust.enableKeybindings"
  },  
  // For working with pview (experimental for one case study)
  {
    "key": "shift+f11",
    "command": "workbench.action.tasks.runTask",
    "args": "Execute Pview Makefile",
    "when": "config.optitrust.enableKeybindings && resourceDirname =~ /^.*\/pview\/.*$/"
  },  
  {
    "key": "shift+f11",
    "command": "workbench.action.tasks.runTask",
    "args": "Execute Pview Demo",
    "when": "config.optitrust.enableKeybindings && resourceDirname =~ /^.*\/demo_pview\/.*$/"
  },    
  // For killing a task, type 'ctrl+k' twice, then 'enter'
  {
     "key": "ctrl+k ctrl+k",
     "command": "workbench.action.tasks.terminate",
     // "args": "Kill the current task",
     "when": "config.optitrust.enableKeybindings"
  }
  // Unused "alt+f6", "alt+f7", "ctrl+shift+f6",..
  // End of OptiTrust keybindings
]
```

Note: the shortcuts refer to tasks that are defined in `.vscode/tasks.json`,
which can be opened by pressing `ctrl+p` then typing `tasks.json`.

You can then adjust the keybindings to match your personal preferences,
by changing the key parameter.


Note: the intermediate state shortcuts (`F7`) are useful for saving checkpoints.
Press `ctrl+F7` to compute the result of a transformation at a given line
of the script. Then, type `F7` on a line further in the file.
The result should be the same as with typing `F6`, except that it runs
faster because the execution proceeds not from the beginning of the script
but instead from the line of the snapshot taken using `ctrl+F7`.

### Deactivate possibly conficting bindings

On desktop managers such as Ubuntu's, certain shortcuts such as
`Alt+F6`, `Alt+F7` etc. are bound to window manipulation operations,
e.g. window resize. If you want to use these shortcuts, you may wish
to deactivate the Ubuntu bindings. To that end, use the following commands:

```sh
  sudo apt-get install dconf-editor
  gsettings set org.gnome.desktop.wm.keybindings begin-move []
  gsettings set org.gnome.desktop.wm.keybindings begin-resize []
  gsettings set org.gnome.desktop.wm.keybindings cycle-group []
  gsettings set org.gnome.desktop.wm.keybindings cycle-group-backward []
  gsettings set org.gnome.desktop.wm.keybindings toggle-maximized []
```

Alternatively, you can open the settings panel, the keyboard menu, the
shortcut submenu, then in the search bar type `Alt+F` (or go to the
'window' group), then select an action, and type `Backspace` to disable
the shortcut, then click on the `save` button.


--------------------------------------------------------------------------------
## Using OptiTrust in VSCode


### Test your installation

We are at last ready to test the installation on a case study.

In VScode, open `case_studies/matmul/matmul.ml` (using e.g. `ctrl+p`).
Place your cursor on the line starting with `!! List.iter tile`.
Type `F6`.
You should see a diff opening up in a browser.

Another shortcut to try is `shift+F5`, on any line of the `matmul.ml` file
After a dozen seconds, you should see the full transformation trace for the
matrix-multiply case study.

### Viewing keyboard shortcuts

It may not be easy at first to recall all the shortcuts. Besides using a sticker
at the bottom of your screen, you can use the command `./shortcuts.sh` to display
the shortcuts, and in VSCode use menu File / Preferences / Keyboard Shortcuts,
then type "optitrust" in the query bar.

### Troubleshooting

If you don't see a diff, possible issues include:
   - Your shortcut is not set up correctly; when the shortcut is pressed,
   a terminal should open to show the output of the task.
     If needed, to investigate whether key bindings are set up properly,
     in VScode type `ctrl+K` immediately followed by `ctrl+s`, then type `alt+k`,
     then type `F6` and see whether you see "Tasks: run tasks" a entry.
   - the compilation failed due to incorrect setup; you should see error
     messages in the terminal.


--------------------------------------------------------------------------------
## Documentation

The documentation for OptiTrust is generated using the OCaml 'odoc' tool.

https://ocaml.github.io/odoc/odoc/odoc_for_authors.html

The top-level command `make doc` calls 'dune build @doc', which invokes 'odoc'.
Then, the generated documentation is copied into the folder '_doc'.
There, the documentation is patched in order to add the diffs associated
with the documentation unit tests (files tests/.../*_doc.ml).

The patch operation is implemented in "doc/add_tests_into_doc.ml".

The top-level command `make viewdoc` compiles the doc and opens it.


--------------------------------------------------------------------------------
## Tester

For running the test suite, execute:

```sh
  cd ~/optitrust
  ~/tester run
```

See the header of the file `tester.ml` for the full documentation.

Optional: in your `~/.bashrc` you can add an alias to make it easier to invoke the tester.

```sh
  alias t='~/optitrust/tester'
```

